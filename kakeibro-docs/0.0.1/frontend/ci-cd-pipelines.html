<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CI/CD Pipelines :: KakeiBro</title>
    <link rel="prev" href="ui-folder-structure-patterns.html">
    <link rel="next" href="vitest.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="../../../_/css/shiki.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">KakeiBro</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/orgs/KakeiBro/repositories" target="_blank">
          <span class="icon">
            <svg aria-hidden="true" data-icon="github" role="img" viewBox="0 0 98 96" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z" fill="#fff"/>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="kakeibro-docs" data-version="0.0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">KakeiBro Docs</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../onboarding/index.html">Onboarding</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../onboarding/backend.html">.NET Solution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ci-cd.html">CI/CD</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../domain/index.html">Domain</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../domain/authentication-module.html">Authentication Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../domain/users-module.html">Users Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../domain/finances-module.html">Finances Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../domain/intelligence-module.html">Intelligence Module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../domain/ubiquitous-language.html">Ubiquitous Language</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../database/index.html">Database</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../prototypes/index.html">Prototypes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../prototypes/o-auth.html">Google OAuth 2.0</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../prototypes/mfa.html">Multi Factor Authentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../prototypes/apache-graphs-react.html">Apache Graphs on React</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../prototypes/forms.html">Form Libraries for React</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../prototypes/formik.html">Formik</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../prototypes/react-hook-form.html">React Hook Form</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../backend/index.html">Backend</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backend/git-hooks.html">Git Hooks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../backend/net-modulith/net-modulith.html">.NET Modulith</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../backend/net-modulith/oauth.html">OAuth</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../backend/net-modulith/folder-structure.html">Folder Structure</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backend/ci-cd-pipelines.html">CI/CD Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backend/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backend/security.html">Security</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Frontend</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="screens/screens.html">Wireframing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="screens/authentication.html">Authentication Screens</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="husky.html">Husky Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ui-folder-structure-patterns.html">UI Folder Structure Patterns</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="ci-cd-pipelines.html">CI/CD Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="vitest.html">Vitest</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">KakeiBro Docs</span>
    <span class="version">0.0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../index.html">KakeiBro Docs</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">KakeiBro Docs</a></li>
    <li><a href="index.html">Frontend</a></li>
    <li><a href="ci-cd-pipelines.html">CI/CD Pipelines</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">CI/CD Pipelines</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>First of all, the pipelines will be built using Github Actions, and they will be
all the way to deployment (Continous Integration/Continuous <strong>Deployment</strong>). With
that in mind we will break down the phylosophy of how they are setup and key points
to take into consideration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By convention pipelines are setup in <code>.yml</code> files that are comitted to the repository.
They should be all under <code>.github/workflows/</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="philosophy"><a class="anchor" href="#philosophy"></a>Philosophy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A robust CI/CD pipeline for any modern application is crucial for ensuring smooth
development, testing, and deployment processes. This specific project takes both
personal experience, but also nuggets of wisdom coming from across experts in the field,
a source for the ideas applied is: <a href="https://www.amazon.com/Hands-Continuous-Integration-Delivery-software-ebook/dp/B07F2KCM75/ref=sr_1_1?crid=BDMDGLVNFVVG&amp;dib=eyJ2IjoiMSJ9.v9neNylqRvqVl8MRAQV2Eetm9ahsqk0XnKJIYkuCKQRFYSRwsoC2KDl40AHiyOX2j5h-7-FzRIqbFwfDJwPaakrOYH_NoHUZud6Ll1BkUmAq0CWLJboij5BqgGKZom-n.lyWaPFA_05QDnljjt2BUT4ykH4G5eTElz8-jDr7zJjQ&amp;dib_tag=se&amp;keywords=Hands-On+Continuous+Delivery&amp;qid=1739626506&amp;sprefix=hands-on+continuous+deliver%2Caps%2C182&amp;sr=8-1">Hands-On Continuous Integration and Delivery</a>.</p>
</div>
<div class="paragraph">
<p>In short, manual processes, and desorganized processes should be mitigated as much
as possible, and it&#8217;s through communication with different areas of the business that we
can find areas of improvement. <strong>Automation</strong> should be a key word when it comes to
relegating processes that are grunt-work in nature and that only take away from more
important tasks for a developer. Besides that, we should have a clear flow of work
in order for the software we build to be fast on delivery and health checking. If
someone coded something that breaks the system, we should pick up on that as quickly
as possible.</p>
</div>
<div class="paragraph">
<p>Whilst we already have put a set of automation steps focused on each workstation through
<a href="husky.html" class="xref page">Husky</a>, there are definitely many ways to circumvent those, and we shouldn&#8217;t
have to rely entirely on each developer&#8217;s willingness to adhere to protocol but a centralized
and (in theory) incorruptible source of thruth. Hence there are other mechanisms to
keep tabs on code quality and correctness (according to a in-house set of rules).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pull Requests</p>
</li>
<li>
<p>CI/CD Pipelines</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Due to the nature of this project, <strong>pull requests</strong> will definitely won&#8217;t be leveraged
as much, unless the need or opportunity for them arises, however they should be still
be in place so that a whole team can have a look at code changes that are about to be
integrated into the codebase and give feedback, and also pick up on possible issues
or opportunities for improvement.</p>
</div>
<div class="paragraph">
<p>But, <strong>Pipelines</strong>, on the other hand will be leveraged in the form of <strong>GitHub Actions</strong>,
there will be one pipeline for <strong>PRs</strong> and another pipeline for CI in <strong>main</strong>. (It&#8217;s
here that you can see that PRs and Pipelines should also come in hand and have arguments
when it comes to trimming down checks for one use case and then adding others for another).</p>
</div>
<div class="paragraph">
<p>Even if a developer has already go through the <strong>layers we have setup</strong> in the form of
<strong>hooks</strong>, we will have pipelines with <strong>some of the same steps</strong> plus others specific
to it so that the process is faster when running on the Remote Repository platform (GitHub).</p>
</div>
<div class="paragraph">
<p>The idea behind <strong>Continous Deployment</strong> is <em>Agile</em> in nature. Always be building
something, testing, and publishing it. It will depend highly on the <em>team and product</em>
if you want to get up until that point, since there might be justified use cases in
which you only want to go all the way to <strong>Continous Delivery</strong>. And by some manual
intervention, the deployment has to be done by someone assigned to said task.</p>
</div>
<div class="paragraph">
<p><strong>In our case</strong>, we are going all the way to deployment, but be aware that this is
extremely taxing in nature, since we are running on a build machine. So be sure to
optimize when pipelines should run and not incurr in them becoming a hassle and source
of frustation, when they should be there to make things easier.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>And in that endeavor of making the pipelines to be as fast as possible, we will leverage
caching, and specifically caching with <code>pnpm</code>. PNPM is already a tool aimed at
reusing node modules if we have them across multiple projects, and it also has optimized
performance built-into it. With that plus a correct usage of <strong>module caching</strong> we
can aim at having cold starts for our frontend builds, but later builds to be much faster
since they will leverage all previously installed node modules, instead of having
to always install them from scratch.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pr-pipeline"><a class="anchor" href="#pr-pipeline"></a>PR Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This consists in <strong>one job</strong> called "Lint, Build, Check". <strong>It will only run on PRs pointed at master</strong>.</p>
</div>
<div class="sect2">
<h3 id="ci"><a class="anchor" href="#ci"></a>CI</h3>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run on a base Ubuntu image, and from the root of the repo, head down to the <code>./kakeibro-web</code> folder.</p>
</li>
<li>
<p>Establish a strategy: Run in parallel two instances of the pipeline (<em>matrix</em>),
one with Node 20 and another one with Node 22</p>
<div class="ulist">
<ul>
<li>
<p><em>A good practice is to test out the build process in different node versions</em>.
Since we are following <a href="../onboarding/index.html#philosophy" class="xref page">best practices</a>,
we should be testing on the <em>Active LTS</em> and <em>Active Maintenance</em> versions of node.</p>
</li>
</ul>
</div>
</li>
<li>
<p>We checkout the code with a pre-defined <code>actions/checkout@v4</code> action</p>
<div class="ulist">
<ul>
<li>
<p><em>Note:</em> At the time of writing the pre-defined actions are at <strong>v4</strong> this could
end up getting updated later, and we should be mindful of this in case there are
actions that are still on other versions such as <strong>v3</strong>.</p>
</li>
<li>
<p><em>Note 2:</em> We have to use these pre-defined sub-routines since github encourages it
and are meant to <strong>abstract</strong> really general use cases such as cloning the repo first,
(the build machine will always start with an empty state), they get the added bonus
of having other syntax that can build on top of the base functionality without us having
to code it from scratch (e.g: Fetch specific commits, optimize performance, attaching submodules)</p>
</li>
</ul>
</div>
</li>
<li>
<p>We install <code>pnpm</code> with <code>pnpm/action-setup@v4</code>. Just like the previous step it will
work with a pre-defined script aimed at abstracting logic and making the file look cleaner</p>
</li>
<li>
<p>We install node with <code>actions/setup-node@v4</code>, in this specific instance we want to tie
it to <code>pnpm</code>, and due to the <em>matrix</em> we setup at the beginning we have to now query the <code>matrix.node-version</code>
variable in order to accomodate node with the respective node version, besides that we can setup
<strong>caching</strong> by simply pointing at it to use a strategy that caches with <code>pnpm</code>. We
also have to point specifically to the <code>pnpm-lock.yaml</code> file so that the pipeline and the
build machine can read it and check their own cache of packages and if all the hashes match
it will then use the cache instead of trying to install everything again from scratch</p>
<div class="ulist">
<ul>
<li>
<p><strong>IMPORTANT:</strong> It is for these types of use cases that comitting the <code>-lock</code> file can
be extremely helpful.</p>
</li>
</ul>
</div>
</li>
<li>
<p>We install all the dependencies with <code>pnpm</code> and with the <code>--frozen-lockfile</code> flag so
that it doesn&#8217;t try to overwrite something on the lockfile.</p>
<div class="ulist">
<ul>
<li>
<p><em>Note:</em> <code>pnpm i --frozen-lockfile</code> is recommended to be used on CI/CD pipelines, to ensure
consistency. The command install dependencies without modifying the <code>pnpm-lock.yaml</code>
file.</p>
</li>
</ul>
</div>
</li>
<li>
<p>We then run <strong>ESLint</strong> by leveraging the scripts that are also leveraged by <a href="husky.html" class="xref page">Husky</a>.</p>
</li>
<li>
<p>We then run a <strong>build</strong> to check that all the code is okay and nothing broke.</p>
</li>
<li>
<p>We then leverage a script called <code>debug-check.js</code> that&#8217;s under a <code>scripts</code> folder at
the web app folder. This is used by both <em>Husky</em> and now the CI/CD pipeline in order to
check for <code>console.log</code> or <code>debugger</code> statements in the code and failing if it does find
them.</p>
</li>
<li>
<p>We then run a <strong>check for outdated packages</strong>, but we fail silently, still the table of
all dependencies that are outdated will show in the pipeline summary.</p>
</li>
<li>
<p>We will then run a script that <strong>checks for package versions that have vulnerabilities</strong>
in them that were found.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="master-pipeline"><a class="anchor" href="#master-pipeline"></a>Master Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This consists of <strong>two jobs</strong>, "Lint, Build, Check", "Deploy to Firebase"</p>
</div>
<div class="sect2">
<h3 id="ci-2"><a class="anchor" href="#ci-2"></a>CI</h3>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run on a base Ubuntu image, and from the root of the repo, head down to the <code>./kakeibro-web</code> folder.</p>
</li>
<li>
<p>Establish a strategy: Run in parallel two instances of the pipeline (<em>matrix</em>),
one with Node 20 and another one with Node 22</p>
<div class="ulist">
<ul>
<li>
<p><em>A good practice is to test out the build process in different node versions</em>.
Since we are following <a href="../onboarding/index.html#philosophy" class="xref page">best practices</a>,
we should be testing on the <em>Active LTS</em> and <em>Active Maintenance</em> versions of node.</p>
</li>
</ul>
</div>
</li>
<li>
<p>We checkout the code with a pre-defined <code>actions/checkout@v4</code> action</p>
<div class="ulist">
<ul>
<li>
<p><em>Note:</em> At the time of writing the pre-defined actions are at <strong>v4</strong> this could
end up getting updated later, and we should be mindful of this in case there are
actions that are still on other versions such as <strong>v3</strong>.</p>
</li>
<li>
<p><em>Note 2:</em> We have to use these pre-defined sub-routines since github encourages it
and are meant to <strong>abstract</strong> really general use cases such as cloning the repo first,
(the build machine will always start with an empty state), they get the added bonus
of having other syntax that can build on top of the base functionality without us having
to code it from scratch (e.g: Fetch specific commits, optimize performance, attaching submodules)</p>
</li>
</ul>
</div>
</li>
<li>
<p>We install <code>pnpm</code> with <code>pnpm/action-setup@v4</code>. Just like the previous step it will
work with a pre-defined script aimed at abstracting logic and making the file look cleaner</p>
</li>
<li>
<p>We install node with <code>actions/setup-node@v4</code>, in this specific instance we want to tie
it to <code>pnpm</code>, and due to the <em>matrix</em> we setup at the beginning we have to now query the <code>matrix.node-version</code>
variable in order to accomodate node with the respective node version, besides that we can setup
<strong>caching</strong> by simply pointing at it to use a strategy that caches with <code>pnpm</code>. We
also have to point specifically to the <code>pnpm-lock.yaml</code> file so that the pipeline and the
build machine can read it and check their own cache of packages and if all the hashes match
it will then use the cache instead of trying to install everything again from scratch</p>
<div class="ulist">
<ul>
<li>
<p><strong>IMPORTANT:</strong> It is for these types of use cases that comitting the <code>-lock</code> file can
be extremely helpful.</p>
</li>
</ul>
</div>
</li>
<li>
<p>We install all the dependencies with <code>pnpm</code> and with the <code>--frozen-lockfile</code> flag so
that it doesn&#8217;t try to overwrite something on the lockfile.</p>
<div class="ulist">
<ul>
<li>
<p><em>Note:</em> <code>pnpm i --frozen-lockfile</code> is recommended to be used on CI/CD pipelines, to ensure
consistency. The command install dependencies without modifying the <code>pnpm-lock.yaml</code>
file.</p>
</li>
</ul>
</div>
</li>
<li>
<p>We then run <strong>ESLint</strong> by leveraging the scripts that are also leveraged by <a href="husky.html" class="xref page">Husky</a>.</p>
</li>
<li>
<p>We then run a <strong>build</strong> to check that all the code is okay and nothing broke.</p>
</li>
<li>
<p>We then leverage a script called <code>debug-check.js</code> that&#8217;s under a <code>scripts</code> folder at
the web app folder. This is used by both <em>Husky</em> and now the CI/CD pipeline in order to
check for <code>console.log</code> or <code>debugger</code> statements in the code and failing if it does find
them.</p>
</li>
<li>
<p>We then run a <strong>check for outdated packages</strong>, but we fail silently, still the table of
all dependencies that are outdated will show in the pipeline summary.</p>
</li>
<li>
<p>We will then run a script that <strong>checks for package versions that have vulnerabilities</strong>
in them that were found.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="deploy"><a class="anchor" href="#deploy"></a>Deploy</h3>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This will depend on the previous <a href="#ci-2">CI</a> step, if it doesn&#8217;t fail then deploy will
run normally</p>
</li>
<li>
<p>Run checkout recipe</p>
</li>
<li>
<p>Run pnpm recipe</p>
</li>
<li>
<p>Run node repice, <strong>with a specific node version</strong>, we are aiming at staying up to
date and with the most modern yet in <em>Active LTS</em> or <em>Maintenance LTS</em> from Node,
and so we setup node with <strong>Version 22</strong>. Same setup to take from cache for modules
if we have them there.</p>
</li>
<li>
<p>Install dependencies with frozen-lockfile</p>
</li>
<li>
<p>Retrieve service account details from the repository&#8217;s secrets vault and save it
under a temporary <code>.json</code> file so that the firebase CLI can pick up on it and use it
for authorization/</p>
</li>
<li>
<p>Run the <code>deploy</code> script. Since the firebase CLI is installed through the <code>package.json</code>
we should have it present, however due to the nature of this being a build machine we
need the service account .json credentials in a file and its path referenced through an
<code>env</code> variable (<code>GOOGLE_APPLICATION_CREDENTIALS</code>)</p>
<div class="ulist">
<ul>
<li>
<p><em>NOTE:</em> We should have configured the <a href="#firebase-token">token on GitHub</a>. Otherwise
the flow will fail since Firebase won&#8217;t authorize the machine to do the deploy.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleanup-pipeline"><a class="anchor" href="#cleanup-pipeline"></a>Cleanup Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As mentioned in the <a href="#pr-pipeline">PR pipeline</a> and the
<a href="#master-pipeline">Master pipeline</a>, we leverage caching in
order to make builds faster, but that doesn&#8217;t come "for free", we need to be well
aware that this has to live somewhere, and whether we use <code>pnpm</code> or the action for
<a href="#github-action-caching">general purpose caching</a>. The moment
the cache varies, may it be due to new dependencies detected, or other external factors,
we will have to generate new caches. And they will start adding up, if we have no use
for old caches we <strong>should clean them up</strong>. And automation of this cleanup is key.</p>
</div>
<div class="paragraph">
<p>It&#8217;s with this in mind that all repositories have a cache cleanup <strong>CRON Action</strong>,
the one specific for the web app is this:</p>
</div>
<div class="listingblock">
<div class="content">
<html><head></head><body><pre class="shiki highlight monokai" style="--shiki-background-color: #272822; --shiki-conum-bg-color: #d2d2cd; --shiki-conum-fg-color: #000000;"><code data-lang="yml" class="shiki has-line-numbers override-conums" style="--shiki-line-number-start: 1; --shiki-line-number-color: #757866;"><span class="line"><span style="color: #F92672">name</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">Cleanup Action Caches</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AE81FF">on</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">schedule</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">    - </span><span style="color: #F92672">cron</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">"0 0 * * *"</span><span style="color: #F8F8F2"> </span><i class="conum" data-value="1"></i><b>(1)</b></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">workflow_dispatch</span><span style="color: #F8F8F2">: </span><i class="conum" data-value="2"></i><b>(2)</b></span>
<span class="line"></span>
<span class="line"><span style="color: #F92672">permissions</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">actions</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">write</span><span style="color: #F8F8F2"> </span><i class="conum" data-value="3"></i><b>(3)</b></span>
<span class="line"></span>
<span class="line"><span style="color: #F92672">jobs</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">clean-cache</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">runs-on</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">ubuntu-latest</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">steps</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">      - </span><span style="color: #F92672">name</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">Get caches list</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">id</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">list-caches</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">run</span><span style="color: #F8F8F2">: </span><span style="color: #F92672">|</span></span>
<span class="line"><span style="color: #E6DB74">          response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \ </span><i class="conum" data-value="4"></i><b>(4)</b></span>
<span class="line"><span style="color: #E6DB74">            -H "Accept: application/vnd.github+json" \ </span><i class="conum" data-value="5"></i><b>(5)</b></span>
<span class="line"><span style="color: #E6DB74">            "https://api.github.com/repos/${{ github.repository }}/actions/caches") </span><i class="conum" data-value="6"></i><b>(6)</b></span>
<span class="line"><span style="color: #E6DB74">          echo "$response" | jq -r '.actions_caches | sort_by(.created_at) | reverse' &gt; caches.json </span><i class="conum" data-value="7"></i><b>(7)</b></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">      - </span><span style="color: #F92672">name</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">Delete old caches</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">run</span><span style="color: #F8F8F2">: </span><span style="color: #F92672">|</span></span>
<span class="line"><span style="color: #E6DB74">          latest_cache_id=$(jq -r '.[0].id' caches.json) </span><i class="conum" data-value="8"></i><b>(8)</b></span>
<span class="line"><span style="color: #E6DB74">          jq -c '.[1:] | .[]' caches.json | while read -r cache; do </span><i class="conum" data-value="9"></i><b>(9)</b></span>
<span class="line"><span style="color: #E6DB74">            cache_id=$(echo $cache | jq -r '.id') </span><i class="conum" data-value="10"></i><b>(10)</b></span>
<span class="line"><span style="color: #E6DB74">            curl -X DELETE -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \</span></span>
<span class="line"><span style="color: #E6DB74">              -H "Accept: application/vnd.github+json" \</span></span>
<span class="line"><span style="color: #E6DB74">              "https://api.github.com/repos/${{ github.repository }}/actions/caches/$cache_id" </span><i class="conum" data-value="11"></i><b>(11)</b></span>
<span class="line"><span style="color: #E6DB74">          done</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">success()</span><span style="color: #F8F8F2"> </span><i class="conum" data-value="12"></i><b>(12)</b></span>
<span class="line"></span></code></pre></body></html>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This Action will be configured as a CRON that runs at 00:00 UTC every day.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In case we need to manually trigger the Action it has the respective flag so that
the option is enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Every action has its own token injected into its runtime, however it&#8217;s by default
<code>read-only</code>. And to delete caches we need for that to also inherit <code>write</code> permissions.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>As mentioned in &lt;3&gt;, the Action will have injected a token for it, it will be saved
under <code>secrets.GITHUB_TOKEN</code>, we will leverage the GitHub API in order to retrieve our cache
list and clean it up, we have to send an Auth token so that the API grants us access and
responds correctly</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>application/vnd.github+json</code> is the media-type from which github responds with,
so we are configuring it to accept the response with that.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Another part of already built-in utilities is the fact that under the <code>github</code>
namespace, we can retrieve variables such as <code>.repository</code>. The value of said variable
will be a unique ID, that in the realm of the GitHub API references our current repository
at which the Action is running.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Whenever we have saved under a variable something, a good practice is to always
reference it with quotation marks to avoid issues with spaces or special characters,
it&#8217;s the result of printing the contents of the variable (that has the response from the
GitHub API) that we pipe into <code>jq</code> a utility to work with JSON strings, another good
practice with it is to use the <code>-r</code> flag so that it won&#8217;t interpret backslashes as escape
characters (so that we don&#8217;t manipulate the response). With <code>jq</code> we can pipe different
instructions that help us navigate a json structure: <code>.actions_caches | sort_by(.created_at) | reverse</code>
firstly points to the <code>.actions_caches</code> property of the JSON object, (we know it&#8217;s an array),
and so we tell the tool to try to sort what&#8217;s unde the key by a <code>created_at</code> field (if the structure
is not an array this would fail), and lastly after the items have been sorted, we will reverse that
result, since we want for the <strong>most recent</strong> entry at the beginning (the top). In the end
the final form of what we transformed is saved under a <code>caches.json</code> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>We have no technical use for this line but just so that the pipeline breaks
if it doesn&#8217;t find a valid entry and so that we can see the value on GitHub, we
will retrieve the latest cache ID under a variable</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The source is a JSON array, and so in order to iterate over it and do something with
the data, we have to apply <code>jq -c '.[1:] | .[]' caches.json</code>, which leverages <code>jq</code>
again in order to read the structure and with <code>-c</code> it will make sure that each JSON
object will be in one separate line, and with <code>.[1:]</code> we try to slice the array to
exclude the first element (the latest cache entry), it&#8217;s then the result of that,
that we iterate over and output it as a separate JSON object with <code>.[]</code>. To that whole
result that <code>jq</code> yields we then apply <strong>Bash shell constructs</strong>, we are applying a
a loop because <code>read</code> is a command that reads a single line from the input, applied
like this we basically are configuring the <code>read</code> to be reading line-by-line and saving
those contents under a <code>cache</code> variable, the moment there are no more lines to read then
the loop will end.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>We then use <code>jq</code> <em>again</em> to extract the specific <code>id</code> field of the <strong>sole</strong> JSON
object that we should have at <code>cache</code>, and we save that <code>id</code> value under a <code>cache_id</code>
variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Just as the previous step we will then hit a GitHub API endpoint in charge of deleting
a cache entry, we send the Action&#8217;s token plus the ID for the cache that we extracted.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Part of GitHub Actions, use this if you want to enforce a condition on a step
<em>or job</em>, so that if the previous step/job was successful then this step can run,
otherwise it won&#8217;t. A good way to enforce short-circuits, still brittle and you have
to add it to each step or job that comes after the declaration of the pivot element.
(Same idea as our <a href="../ci-cd.html#gh-action-3" class="xref page">conditional execution for deployment</a>)</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="firebase"><a class="anchor" href="#firebase"></a>Firebase</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Firebase has a service called <code>Hosting</code>. Following its <a href="https://firebase.google.com/docs/hosting/?hl=en&amp;authuser=0#implementation_path">documentation</a>
we can integrate firebase into our web app repository.</p>
</div>
<div class="paragraph">
<p>In the Firebase Console it&#8217;s best to create a project. We have created one for the
whole kakeibro app.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A good practice so that we adhere to DevOps practices, is to have the firebase CLI
in the form of a node package, meaning it should be declared on our <code>packages.json</code>
but as a <strong>devDependency</strong>, since this package has nothing to do with the user experience,
it&#8217;s for deployment purposes. This also integrates better with CI/CD pipelines due to
the fact that we can cache later that dependency. Instead of wanting to run it with a
global tool that doesn&#8217;t cache unless we do more work.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Head into the web app folder</p>
</li>
<li>
<p>(With the Firebase CLI intalled) run <code>firebase init</code></p>
</li>
<li>
<p>Type <code>Y</code></p>
</li>
<li>
<p>Select <code>Hosting</code></p>
</li>
<li>
<p><code>Use an existing project</code></p>
</li>
<li>
<p>Select the project that you have in Firebase</p>
</li>
<li>
<p>Since vite outputs a bundle to a <code>./dist</code> folder, we will put that as the <em>public
directory</em>.</p>
</li>
<li>
<p>Accept <code>Configure as SPA</code></p>
</li>
<li>
<p>Do not setup GitHub Actions (we will do that on our own)</p>
</li>
<li>
<p>Do not overwrite the <code>index.html</code> (we should have ran a build already)</p>
</li>
<li>
<p>Right after this whole setup we should have a <code>.firebaserc</code> and <code>firebase.json</code>
files in our repo. We should commit those, they are key instruments when running a
<code>firebase deploy</code></p>
</li>
<li>
<p>Add a script at <code>package.json</code> so that it automates things (you can name it <code>deploy</code>).
It should build the whole project and then run the firebase CLI tool.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to the nature of Firebase and just to test out the script ourselves, it would be
best to run locally the <code>pnpm deploy</code> command. To see if we are able to deploy our
app to Firebase. This can definitely be automated with IaC, such as Terraform, however
for our purposes, it will be a one-time manual configuration so that we make sure we
deploy the app correctly and then configure a custom domain. Wait for SSL providing and
everything, and then relying on the action to deploy it after that. (We shouldn&#8217;t have
to run it manually anymore). More info at <a href="#ci-constraints">parameters for scripts</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After we have wired up the firebase domain through a <code>CNAME</code> record for our custom
domain, (don&#8217;t forget to add 2 records one for the <code>www</code> subdomain and another one
without it). We should be able to hit both <code>kakeibro.dsbalderrama.top</code> and
<code>www.kakeibro.dsbalderrama.top</code> and get our app right there running.</p>
</div>
<div class="paragraph">
<p><strong>NOTE: </strong> Don&#8217;t forget to add the <code>.firebase/</code> folder to <code>.gitignore</code>.</p>
</div>
<div id="firebase-token" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>DISCLAIMER:</strong> The next paragraph&#8217;s approach has been deprecated, and might break in the future. The project
uses a <a href="#danger-of-deprecation-of-token">service account</a>, however for the purposes of having the docs with more information
these pieces of information are kept.</p>
</div>
<div class="paragraph">
<p>In order to generate a token so that our action can then run a deploy. We can run
<code>firebase login:ci</code>. This will open up a web browser with Google OAuth so that we log
in with the account that has access to the Firebase project, we have to consent
and everything. After the flow is done, we will get the token printed in the console
screen. <strong>SAVE THIS AS A GITHUB SECRET AND NEVER TOUCH IT AGAIN</strong>. We leverage it
on the github action to log into firebase with the token so that we can then run the
deploy.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="ci-constraints" class="paragraph">
<p>The whole <code>firebase login:ci</code> command generates a token specifically to be run on a
pipeline and it is by design enforced to be passed only at the <code>firebase deploy --only hosting --token $FIREBASE_TOKEN</code>
level. We can&#8217;t log into Firebase with this token, and it&#8217;s in this specific endeavor that
the <code>deploy</code> script has to be modified so that we can pass to the <code>firebase</code> command
all of the different parameters <code>tsc -b &amp;&amp; vite build &amp;&amp; firebase deploy --only hosting</code>. By adding
the last parameter we will be setting by default for the command to always run the deployment
only for <em>hosting</em> and we can then attach to it extra arguments. And so, when we run
<code>pnpm run deploy --token ${{ secrets.FIREBASE_TOKEN }}</code> we will have all of those parameters after <code>deploy</code>
attached to the <code>firebase deploy --only hosting &#8230;&#8203;</code> section of the <code>deploy</code> script.</p>
</div>
<div class="paragraph">
<p><strong><em>Small note:</em></strong> A good practice, to avoid issues, would be the usage of <code>--only hosting</code>,
so that the whole project only tries to deploy to the SPA section of the whole Firebase
project. There might be times at which running that without the flag will attempt
to deploy to other services and end up breaking something.</p>
</div>
<div class="sect2">
<h3 id="about-www-domain-vs-clean-name"><a class="anchor" href="#about-www-domain-vs-clean-name"></a>About www domain vs clean name</h3>
<div class="paragraph">
<p>Firebase will need to have a second domain added to it so that it redirects the
<code>www</code> subdomain to our <code>non-www</code> subdomain. (Github Pages sets that up automatically).</p>
</div>
<div class="paragraph">
<p>A good recommendation is <strong>at the DNS level</strong> to setup the second CNAME record to point
to the non-www CNAME.</p>
</div>
<div class="paragraph">
<p>The DNS configuration side <strong>isn&#8217;t enough though</strong>, <strong>the server</strong> needs to take care of
<strong>redirecting things</strong>, the HTTP redirection if you will. Hence we will have to make these
two configurations ourselves. One on Firebase (the server), and another on our
DNS provider.</p>
</div>
</div>
<div class="sect2">
<h3 id="danger-of-deprecation-of-token"><a class="anchor" href="#danger-of-deprecation-of-token"></a>Danger of deprecation of <code>--token</code></h3>
<div class="paragraph">
<p>When running the previous <code>--token</code> parameter approach we will get a warning stating:</p>
</div>
<div class="listingblock">
<div class="content">
<html><head></head><body><pre class="shiki highlight monokai" style="--shiki-background-color: #272822; --shiki-conum-bg-color: #d2d2cd; --shiki-conum-fg-color: #000000;"><code class="shiki has-line-numbers override-conums" style="--shiki-line-number-start: 1; --shiki-line-number-color: #757866;"><span class="line"><span style="color: #F8F8F2">Authenticating with `--token` is deprecated and will be removed in a future major version of `firebase-tools`. Instead, use a service account key with `GOOGLE_APPLICATION_CREDENTIALS`: https://cloud.google.com/docs/authentication/getting-started</span></span></code></pre></body></html>
</div>
</div>
<div class="paragraph">
<p>This indicates that we should move away from using this CI token and instead use the
<a href="../backend/ci-cd-pipelines.html#gcp" class="xref page">service account keys</a> approach. We should be
managing different keys for different services, since using a master <code>.json</code> credentials
key is a one-point-of-failure. If it gets compromised, <strong>ALL OF YOUR SERVICES ARE COMPROMISED</strong>.
We have to download it as a <code>.json</code> file, and then upload it as a secret to the repository
(the text).</p>
</div>
<div class="paragraph">
<p>Firebase projects end up as <strong>different GCloud projects</strong>, the best way to manage their
credentials is to head to the <em>Project Settings</em> and under the <em>Service Accounts</em>
tab we can then click on the <em>All service accounts</em> link. It will take us to a GCloud
instance in where we <em>might</em> see an already configured Service Account for us. We
can then head down to <strong>Service Accounts</strong> in the GCloud pannel and generate a key for
that service account that has access to our firebase project in charge of the website.</p>
</div>
<div class="paragraph">
<p>It&#8217;s with that in mind that the command can get rid of the <code>--token</code> parameter,
and we can leverage env variables and the secret text like this:</p>
</div>
<div class="listingblock">
<div class="content">
<html><head></head><body><pre class="shiki highlight monokai" style="--shiki-background-color: #272822; --shiki-conum-bg-color: #d2d2cd; --shiki-conum-fg-color: #000000;"><code data-lang="yml" class="shiki has-line-numbers override-conums" style="--shiki-line-number-start: 1; --shiki-line-number-color: #757866;"><span class="line"><span style="color: #F8F8F2">- </span><span style="color: #F92672">name</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">Setup service account credentials</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">run</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">echo '${{ secrets.GCLOUD_SERVICE_ACCOUNT }}' &gt; $HOME/gcloud-service-key.json</span><span style="color: #F8F8F2"> </span><i class="conum" data-value="1"></i><b>(1)</b></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">- </span><span style="color: #F92672">name</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">Set GOOGLE_APPLICATION_CREDENTIALS</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">run</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json" &gt;&gt; $GITHUB_ENV</span><span style="color: #F8F8F2"> </span><i class="conum" data-value="2"></i><b>(2)</b></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">- </span><span style="color: #F92672">name</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">Build and Deploy to Firebase</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">env</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">run</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">pnpm run deploy</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">- </span><span style="color: #F92672">name</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">Cleanup service account file</span></span>
<span class="line"><span style="color: #F8F8F2">  </span><span style="color: #F92672">run</span><span style="color: #F8F8F2">: </span><span style="color: #E6DB74">rm -f $HOME/gcloud-service-key.json</span><span style="color: #F8F8F2"> </span><i class="conum" data-value="3"></i><b>(3)</b></span>
<span class="line"></span></code></pre></body></html>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The main thing is that the env variable is expecting a <code>.json</code> file path, not the
actual json string. Hence we have to copy the contents for a brief second to a file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It&#8217;s then that we save as an env variable (so that it persists for the next steps),
the path to the file we saved with the service account json string.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Lastly, as a security measure, we will delete the temporary file with our credentials
as a form of cleanup.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>References:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://devy.in/post/how-to-setup-gitlab-cicd-pipeline-to-deploy-nextjs-app-to-firebase">Blog</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/75653962/firebase-token-deprecated-in-ci-cd-gitlab">Gitlab example</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can edit the levels of access for a service account by heading to <code>IAM</code> selecting
the service account you want to modify, and with the pencil icon. You get a menu
to modify the levels of access of the account.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="possible-audit-blockers"><a class="anchor" href="#possible-audit-blockers"></a>Possible audit blockers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When running the <code>pnpm audit</code> step and we do find a vulnerability for a package,
then that immediately returns a <strong>1</strong>. And a pipeline will fail, whilst this is great
because our controls are in check, it might end up blocking development if we don&#8217;t do
something about it, and this is due to the fact that sometimes this package might
be a <em>transitive dependency</em>. And until that gets fixed in our direct referenced packages
with a version bump, we will be stuck, this depends on other&#8217;s and we can&#8217;t block
the development flow due to this.</p>
</div>
<div class="paragraph">
<p>And so, an options is to fail silently, <strong>but staying on top updates</strong>, this can be
done as easily as <code>pnpm audit || echo 'Failing audit silently, waiting for esbuild bump'</code>.</p>
</div>
<div class="paragraph">
<p>We could even go further and automate this, but nevertheless, this is just part of
the workflow that&#8217;s established, some of the pains we have to accept and how to still
get value out of everything that was setup.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As mentioned in <a href="#ci">CI</a>, we have a <strong>matrix</strong>, one cool thing about GitHub is that it will
indeed try to optimize runs, and that is in the form that if some of the matrix instances
fails, if another one is still in the middle of running, it will stop immediately and
be cancelled.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A way to be on top of updates is to always be checking on forums (hopefully GitHub)
about how the maintainers will deal with this dependency.</p>
</div>
<div class="paragraph">
<p>E.g: <a href="https://github.com/vitejs/vite/pull/19389#issuecomment-2671015753">GitHub Issue</a>.</p>
</div>
<div class="paragraph">
<p>Depending on how people are looking at it you might even want to start adding the specific
vulnerability to exceptions:</p>
</div>
<div class="listingblock">
<div class="content">
<html><head></head><body><pre class="shiki highlight monokai" style="--shiki-background-color: #272822; --shiki-conum-bg-color: #d2d2cd; --shiki-conum-fg-color: #000000;"><code class="shiki has-line-numbers override-conums" style="--shiki-line-number-start: 1; --shiki-line-number-color: #757866;"><span class="line"><span style="color: #F8F8F2">  "pnpm":{</span></span>
<span class="line"><span style="color: #F8F8F2">    "auditConfig": {</span></span>
<span class="line"><span style="color: #F8F8F2">      "ignoreGhsas": [</span></span>
<span class="line"><span style="color: #F8F8F2">        "GHSA-67mh-4wv8-2f99"</span></span>
<span class="line"><span style="color: #F8F8F2">      ]</span></span>
<span class="line"><span style="color: #F8F8F2">    }</span></span>
<span class="line"><span style="color: #F8F8F2">  }</span></span></code></pre></body></html>
</div>
</div>
<div class="paragraph">
<p>This, for example, takes care of an <code>esbuild</code> vulnerability that won&#8217;t be fixed until
a next major release for Vite, hence we will have to make do with the vulnerability.
(And also adds extra info to our end as developers with a dependency), a decision
in this specific use case was to make an update to V6.2 (for example) the moment it&#8217;s
available since that will get rid of this vulnerability.</p>
</div>
<div class="paragraph">
<p><strong>Outdated:</strong> Depending on the versions, we could get the <code>pnpm outdated</code> package
failing instead of just adding "warnings". E.g.: <code>globals</code> went from version <code>15.15.0</code>
to <code>16.0.0</code> and the step now started failing. How would you fix this? Try to run a
<code>pnpm update</code>, if this doesn&#8217;t bump it to the version that is the latest, manually
edit it and then run <code>pnpm update</code> again.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="ui-folder-structure-patterns.html">UI Folder Structure Patterns</a></span>
  <span class="next"><a href="vitest.html">Vitest</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
